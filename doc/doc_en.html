<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2024-10-15 17:19 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>yy-render &#x2014; Documentation</title>
<meta name="generator" content="Org Mode">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap" rel="stylesheet">
<style>
/*
 * get from https://github.com/w3c/tr-design/blob/gh-pages/src/base.css
 * commit: https://github.com/w3c/tr-design/commit/914ccdd066f0e8dc77611a903b9f0c3f7c2561b3
 * date: 2024-04-18 17:59 steal by <include-yy yy@egh0bww1.com>
*/

/******************************************************************************
 *                   Style sheet for the W3C specifications                   *
 *
 * Special classes handled by this style sheet include:
 *
 * Indices
 *   - .toc for the Table of Contents (<ol class="toc">)
 *     + <span class="secno"> for the section numbers
 *   - #toc for the Table of Contents (<nav id="toc">)
 *   - ul.index for Indices (<a href="#ref">term</a><span>, in Â§N.M</span>)
 *   - table.index for Index Tables (e.g. for properties or elements)
 *
 * Structural Markup
 *   - table.data for general data tables
 *     -> use 'scope' attribute, <colgroup>, <thead>, and <tbody> for best results !
 *     -> use <table class='complex data'> for extra-complex tables
 *     -> use <td class='long'> for paragraph-length cell content
 *     -> use <td class='pre'> when manual line breaks/indentation would help readability
 *   - dl.switch for switch statements
 *   - ol.algorithm for algorithms (helps to visualize nesting)
 *   - .figure and .caption (HTML4) and figure and figcaption (HTML5)
 *     -> .sidefigure for right-floated figures
 *   - ins/del
 *     -> ins/del[cite] for candidate and proposed changes (amendments)
 *
 * Code
 *   - pre and code
 *
 * Special Sections
 *   - .note       for informative notes             (div, p, span, aside, details)
 *   - .example    for informative examples          (div, p, pre, span)
 *   - .issue      for issues                        (div, p, span)
 *   - .advisement for loud normative statements     (div, p, strong)
 *   - .annoying-warning for spec obsoletion notices (div, aside, details)
 *   - .correction for "candidate corrections"       (div, aside, details, section)
 *   - .addition   for "candidate additions"         (div, aside, details, section)
 *   - .correction.proposed for "proposed corrections" (div, aside, details, section)
 *   - .addition.proposed   for "proposed additions"   (div, aside, details, section)
 *
 * Definition Boxes
 *   - pre.def   for WebIDL definitions
 *   - table.def for tables that define other entities (e.g. CSS properties)
 *   - dl.def    for definition lists that define other entitles (e.g. HTML elements)
 *
 * Numbering
 *   - .secno for section numbers in .toc and headings (<span class='secno'>3.2</span>)
 *   - .marker for source-inserted example/figure/issue numbers (<span class='marker'>Issue 4</span>)
 *   - ::before styled for CSS-generated issue/example/figure numbers:
 *     -> Documents wishing to use this only need to add
 *        figcaption::before,
 *        .caption::before { content: "Figure "  counter(figure) " ";  }
 *        .example::before { content: "Example " counter(example) " "; }
 *        .issue::before   { content: "Issue "   counter(issue) " ";   }
 *
 * Header Stuff (ignore, just don't conflict with these classes)
 *   - .head for the header
 *   - .copyright for the copyright
 *
 * Outdated warning for old specs
 *
 * Miscellaneous
 *   - .overlarge for things that should be as wide as possible, even if
 *     that overflows the body text area. This can be used on an item or
 *     on its container, depending on the effect desired.
 *     Note that this styling basically doesn't help at all when printing,
 *     since A4 paper isn't much wider than the max-width here.
 *     It's better to design things to fit into a narrower measure if possible.
 *
 *   - js-added ToC jump links (see fixup.js)
 *
 *   - .uname and .codepoint for character names and examples
 *
 ******************************************************************************/


/******************************************************************************/
/*                                  Colors                                    */
/******************************************************************************/

/* Any --*-text not paired with a --*-bg is assumed to have a transparent bg */
:root {
	--text: black;
	--bg: white;

	/* Absolute URLs due to https://bugs.webkit.org/show_bug.cgi?id=230243 */
	/*
	--unofficial-watermark: url(https://www.w3.org/StyleSheets/TR/2021/logos/UD-watermark-light-unofficial.svg);
	--draft-watermark: url(https://www.w3.org/StyleSheets/TR/2021/logos/UD-watermark-light-draft.svg);
	*/

	--logo-bg: #1a5e9a;
	--logo-active-bg: #c00;
	--logo-text: white;

	--tocnav-normal-text: #707070;
	--tocnav-normal-bg: var(--bg);
	--tocnav-hover-text: var(--tocnav-normal-text);
	--tocnav-hover-bg: #f8f8f8;
	--tocnav-active-text: #c00;
	--tocnav-active-bg: var(--tocnav-normal-bg);

	--tocsidebar-text: var(--text);
	--tocsidebar-bg: #f7f8f9;
	--tocsidebar-shadow: rgba(0,0,0,.1);
	--tocsidebar-heading-text: hsla(203,20%,40%,.7);

	--toclink-text: var(--text);
	--toclink-underline: #3980b5;
	--toclink-visited-text: var(--toclink-text);
	--toclink-visited-underline: #054572;

	--heading-text: #005a9c;

	--hr-text: var(--text);

	--algo-border: #def;

	--del-text: #AA0000;
	--del-bg: transparent;
	--ins-text: #006100;
	--ins-bg: transparent;

	--a-normal-text: #034575;
	--a-normal-underline: #707070;
	--a-visited-text: var(--a-normal-text);
	--a-visited-underline: #bbb;
	--a-hover-bg: rgba(75%, 75%, 75%, .25);
	--a-active-text: #c00;
	--a-active-underline: #c00;

	--blockquote-border: silver;
	--blockquote-bg: transparent;
	--blockquote-text: var(--text);

	--issue-border: #e05252;
	--issue-bg: #fbe9e9;
	--issue-text: var(--text);
	--issueheading-text: #831616;

	--example-border: #e0cb52;
	--example-bg: #fcfaee;
	--example-text: var(--text);
	--exampleheading-text: #574b0f;

	--note-border: #52e052;
	--note-bg: #e9fbe9;
	--note-text: var(--text);
	--noteheading-text: hsl(120, 70%, 22%);
	--notesummary-underline: silver;

	--advisement-border: orange;
	--advisement-bg: #fec;
	--advisement-text: var(--text);
	--advisementheading-text: #b35f00;

	--amendment-border: #330099;
	--amendment-bg: #F5F0FF;
	--amendment-text: var(--text);
	--amendmentheading-text: #220066;

	--warning-border: red;
	--warning-bg: hsla(40,100%,50%,0.95);
	--warning-text: var(--text);

	--def-border: #8ccbf2;
	--def-bg: #def;
	--def-text: var(--text);
	--defrow-border: #bbd7e9;

	--datacell-border: silver;

	--indexinfo-text: #707070;

	--indextable-hover-text: black;
	--indextable-hover-bg: #f7f8f9;

	--outdatedspec-bg: rgba(0, 0, 0, .5);
	--outdatedspec-text: black;
	--outdated-bg: maroon;
	--outdated-text: white;
	--outdated-shadow: red;

	--editedrec-bg: darkorange;
}

/******************************************************************************/
/*                                   Body                                     */
/******************************************************************************/

	body {
		counter-reset: example figure issue;

		/* Layout */
		max-width: 50em;             /* limit line length to 50em for readability   */
		margin: 0 auto 4em;          /* center text within page, space for footers  */
		padding: 1.6em 1.5em 0 50px; /* assume 16px font size for downlevel clients */
		padding: 1.6em 1.5em 0 calc(26px + 1.5em); /* leave space for status flag   */

		/* Typography */
		line-height: 1.5;
		font-family: sans-serif;
		widows: 2;
		orphans: 2;
		word-wrap: break-word;
		overflow-wrap: break-word;

		/* Colors */
		color: black;
		color: var(--text);
		background: white top left fixed no-repeat;
		background-color: var(--bg);
		background-size: 25px auto;
	}

/******************************************************************************/
/*                         Front Matter & Navigation                          */
/******************************************************************************/

/** Header ********************************************************************/

	div.head { margin-bottom: 1em; }
	div.head hr { border-style: solid; }

	div.head h1 {
		font-weight: bold;
		margin: 0 0 .1em;
		font-size: 220%;
	}

	#w3c-state {
		margin-top: 0;
		margin-bottom: 1.5em;
		font: 140% sans-serif;   /* Reset all font styling to clear out UA styles */
		font-family: inherit;    /* Inherit the font family. */
		line-height: 1.2;        /* Keep wrapped headings compact */
		hyphens: manual;         /* Hyphenated headings look weird */
		color: #005a9c;
		color: var(--heading-text);
	}

/** W3C Logo ******************************************************************/

	.head p:not(.copyright):first-child {
		margin: 0;
	}

	.head p:not(.copyright):first-child > a,
	.head > a:first-child {
		float: right;
		margin: 0.4rem 0 0.2rem .4rem;
	}

	.head img[src*="logos/W3C"] {
		display: block;
		border: solid #1a5e9a;
		border: solid var(--logo-bg);
		border-width: .65rem .7rem .6rem;
		border-radius: .4rem;
		background: #1a5e9a;
		background: var(--logo-bg);
		color: white;
		color: var(--logo-text);
		font-weight: bold;
	}

	.head a:hover > img[src*="logos/W3C"],
	.head a:focus > img[src*="logos/W3C"] {
		opacity: .8;
	}

	.head a:active > img[src*="logos/W3C"] {
		background: #c00;
		background: var(--logo-active-bg);
		border-color: #c00;
		border-color: var(--logo-active-bg);
	}

	/* see also additional rules in Link Styling section */

/** Copyright *****************************************************************/

	p.copyright,
	p.copyright small { font-size: small; }

/** Back to Top / ToC Toggle **************************************************/

	@media print {
		#toc-nav {
			display: none;
		}
	}
	@media not print {
		#toc-nav {
			position: fixed;
			z-index: 3;
			bottom: 0; left: 0;
			margin: 0;
			min-width: 1.33em;
			border-top-right-radius: 2rem;
			box-shadow: 0 0 2px;
			font-size: 1.5em;
		}
		#toc-nav > a {
			display: block;
			white-space: nowrap;

			height: 1.33em;
			padding: .1em 0.3em;
			margin: 0;

			box-shadow: 0 0 2px;
			border: none;
			border-top-right-radius: 1.33em;

			color: #707070;
			color: var(--tocnav-normal-text);
			background: white;
			background: var(--tocnav-normal-bg);
		}
		#toc-nav > a:hover,
		#toc-nav > a:focus {
			color: black;
			color: var(--tocnav-hover-text);
			background: #f8f8f8;
			background: var(--tocnav-hover-bg);
		}
		#toc-nav > a:active {
			color: #c00;
			color: var(--tocnav-active-text);
			background: white;
			background: var(--tocnav-active-bg);
		}

		#toc-nav > #toc-jump,
		#toc-nav > #toc-toggle {
			padding-bottom: 2em;
			margin-bottom: -1.9em;
		}

		/* statusbar gets in the way on keyboard focus; remove once browsers fix */
		#toc-nav > a[href="#toc"]:not(:hover):focus:last-child {
			padding-bottom: 1.5rem;
		}

		#toc-nav:not(:hover) > a:not(:focus) > span + span {
			/* Ideally this uses :focus-within on #toc-nav */
			display: none;
		}
		#toc-nav > a > span + span {
			padding-right: 0.2em;
		}
	}

/** ToC Sidebar ***************************************************************/

	/* Floating sidebar */
	@media screen {
		body.toc-sidebar #toc {
			position: fixed;
			top: 0; bottom: 0;
			left: 0;
			width: 23.5em;
			max-width: 80%;
			max-width: calc(100% - 2em - 26px);
			overflow: auto;
			padding: 0 1em;
			padding-left: 42px;
			padding-left: calc(1em + 26px);
			color: black;
			color: var(--tocsidebar-text);
			background: inherit;
			background-color: #f7f8f9;
			background-color: var(--tocsidebar-bg);
			z-index: 1;
			box-shadow: -.1em 0 .25em rgba(0,0,0,.1) inset;
			box-shadow: -.1em 0 .25em var(--tocsidebar-shadow) inset;
		}
		body.toc-sidebar #toc h2 {
			margin-top: .8rem;
			font-variant: small-caps;
			font-variant: all-small-caps;
			text-transform: lowercase;
			font-weight: bold;
			color: gray;
			color: hsla(203,20%,40%,.7);
			color: var(--tocsidebar-heading-text);
		}
		body.toc-sidebar #toc-jump:not(:focus) {
			width: 0;
			height: 0;
			padding: 0;
			position: absolute;
			overflow: hidden;
		}
	}
	/* Hide main scroller when only the ToC is visible anyway */
	@media screen and (max-width: 28em) {
		body.toc-sidebar {
			overflow: hidden;
		}
	}

	/* Sidebar with its own space */
	@media screen and (min-width: 78em) {
		body:not(.toc-inline) #toc {
			position: fixed;
			top: 0; bottom: 0;
			left: 0;
			width: 23.5em;
			overflow: auto;
			padding: 0 1em;
			padding-left: 42px;
			padding-left: calc(1em + 26px);
			color: black;
			color: var(--tocsidebar-text);
			background: inherit;
			background-color: #f7f8f9;
			background-color: var(--tocsidebar-bg);
			z-index: 1;
			box-shadow: -.1em 0 .25em rgba(0,0,0,.1) inset;
			box-shadow: -.1em 0 .25em var(--tocsidebar-shadow) inset;
		}
		body:not(.toc-inline) #toc h2 {
			margin-top: .8rem;
			font-variant: small-caps;
			font-variant: all-small-caps;
			text-transform: lowercase;
			font-weight: bold;
			color: gray;
			color: hsla(203,20%,40%,.7);
			color: var(--tocsidebar-heading-text);
		}

		body:not(.toc-inline) {
			padding-left: 29em;
		}
		/* See also Overflow section at the bottom */

		body:not(.toc-inline) #toc-jump:not(:focus) {
			width: 0;
			height: 0;
			padding: 0;
			position: absolute;
			overflow: hidden;
		}
	}
	@media screen and (min-width: 90em) {
		body:not(.toc-inline) {
			margin: 0 4em;
		}
	}

/******************************************************************************/
/*                                Sectioning                                  */
/******************************************************************************/

/** Headings ******************************************************************/

	h1, h2, h3, h4, h5, h6, dt {
		page-break-after: avoid;
		page-break-inside: avoid;
		font: 100% sans-serif;   /* Reset all font styling to clear out UA styles */
		font-family: inherit;    /* Inherit the font family. */
		line-height: 1.2;        /* Keep wrapped headings compact */
		hyphens: manual;         /* Hyphenated headings look weird */
	}

	h2, h3, h4, h5, h6 {
		margin-top: 3rem;
	}

	h1, h2, h3 {
		color: #005a9c;
		color: var(--heading-text);
	}

	h1 { font-size: 170%; }
	h2 { font-size: 140%; }
	h3 { font-size: 120%; }
	h4 { font-weight: bold; }
	h5 { font-style: italic; }
	h6 { font-variant: small-caps; }
	dt { font-weight: bold; }

/** Subheadings ***************************************************************/

	h1 + h2,
	#subtitle {
		/* #subtitle is a subtitle in an H2 under the H1 */
		margin-top: 0;
	}
	h2 + h3,
	h3 + h4,
	h4 + h5,
	h5 + h6 {
		margin-top: 1.2em; /* = 1 x line-height */
	}

/** Section divider ***********************************************************/

	:not(.head) > :not(.head) + hr {
		font-size: 1.5em;
		text-align: center;
		margin: 1em auto;
		height: auto;
		color: black;
		color: var(--hr-text);
		border: transparent solid 0;
		background: transparent;
	}
	:not(.head) > hr::before {
		content: "\2727\2003\2003\2727\2003\2003\2727";
	}

/******************************************************************************/
/*                            Paragraphs and Lists                            */
/******************************************************************************/

	p {
		margin: 1em 0;
	}

	dd > p:first-child,
	li > p:first-child {
		margin-top: 0;
	}

	ul, ol {
		margin-left: 0;
		padding-left: 2em;
	}

	li {
		margin: 0.25em 0 0.5em;
		padding: 0;
	}

	dl dd {
		margin: 0 0 .5em 2em;
	}

	.head dd + dd { /* compact for header */
		margin-top: -.5em;
	}

	/* Style for algorithms */
	ol.algorithm ol:not(.algorithm),
	.algorithm > ol ol:not(.algorithm) {
	 border-left: 0.5em solid #def;
	 border-left: 0.5em solid var(--algo-border);
	}

	/* Style for switch/case <dl>s */
	dl.switch > dd > ol.only {
	 margin-left: 0;
	}
	dl.switch > dd > ol.algorithm {
	 margin-left: -2em;
	}
	dl.switch {
	 padding-left: 2em;
	}
	dl.switch > dt {
	 margin-top: 1em;
	}
	dl.switch > dt + dt {
	 margin-top: 0;
	}

	/* For older browsers */
	dl.switch > dt::before {
	 content: '\21AA';
	 padding: 0 0.5em 0 0;
	 display: inline-block;
	 width: 1em;
	 text-align: right;
	 line-height: 0.5em;
	}
	dl.switch > dt {
	 text-indent: -1.5em;
	}
	:where(dl.switch > dt > *) {
		text-indent: 0; /* break inheritance on e.g. list children */
	}
	/* Undo above styling and use list-style for proper bullets */
	@supports (list-style: "\21AA  ") {
		dl.switch > dt {
			display: list-item;
			counter-increment: list-item 0;
			list-style: "\21AA  ";
			margin-left: -1.5em;
			text-indent: 0;
		}
		dl.switch > dt::before {
			content: none;
		}
	}


/** Terminology Markup ********************************************************/


/******************************************************************************/
/*                                 Inline Markup                              */
/******************************************************************************/

/** Terminology Markup ********************************************************/
	dfn   { /* Defining instance */
		font-weight: bolder;
	}
	a > i { /* Instance of term */
		font-style: normal;
	}
	dt dfn code, code.idl {
		font-size: inherit;
	}
	dfn var {
		font-style: normal;
	}

/** Change Marking ************************************************************/

	del {
		color: #AA0000;
		color: var(--del-text);
		background: transparent;
		background: var(--del-bg);
		text-decoration: line-through;
	}
	ins {
		color: #006100;
		color: var(--ins-text);
		background: transparent;
		background: var(--ins-bg);
		text-decoration: underline;
		text-decoration-style: dashed;
	}
	ins:not(#dontusethisid) *,
	del:not(#dontusethisid) * {
		color: inherit;
	}
	ins:not([hidden]).diff-inactive,
	del:not([hidden]).diff-inactive {
		all: unset;
	}
	ins:not(.diff-inactive) *,
	del:not(.diff-inactive) * {
		color: inherit;
	}

	/* for amendments (candidate/proposed changes) */
	.amendment ins, .correction ins, .addition ins,
	ins[cite] { text-decoration-style: dotted; }
	.amendment del, .correction del, .addition del,
	del[cite] { text-decoration-style: dotted; }
	.amendment.proposed ins, .correction.proposed ins, .addition.proposed ins,
	ins[cite].proposed { text-decoration-style: double; }
	.amendment.proposed del, .correction.proposed del, .addition.proposed del,
	del[cite].proposed { text-decoration-style: double; }

/** Miscellaneous improvements to inline formatting ***************************/

	sup {
		vertical-align: super;
		font-size: 80%;
	}

/******************************************************************************/
/*                                    Code                                    */
/******************************************************************************/

/** General monospace/pre rules ***********************************************/

	pre, code, samp {
		font-family: Menlo, Consolas, "DejaVu Sans Mono", Monaco, monospace;
		font-size: .9em;
		hyphens: none;
		text-transform: none;
		text-align: left;
		text-align: start;
		font-variant: normal;
		orphans: 3;
		widows: 3;
		page-break-before: avoid;
	}
	pre code,
	code code {
		font-size: 100%;
	}

	pre {
		margin-top: 1em;
		margin-bottom: 1em;
		overflow: auto;
	}

/** Inline Code fragments *****************************************************/

  /* Do something nice. */

/******************************************************************************/
/*                                    Links                                   */
/******************************************************************************/

/** General Hyperlinks ********************************************************/

	/* We hyperlink a lot, so make it less intrusive */
	a[href] {
		color: #034575;
		color: var(--a-normal-text);
		text-decoration-color: #707070;
		text-decoration-color: var(--a-normal-underline);
		text-decoration-skip-ink: none;
	}
	a:visited {
		color: #034575;
		color: var(--a-visited-text);
		text-decoration-color: #bbb;
		text-decoration-color: var(--a-visited-underline);
	}

	/* Indicate interaction with the link */
	a[href]:focus,
	a[href]:hover {
		text-decoration-thickness: 2px;
		text-decoration-skip-ink: none;
	}
	a[href]:active {
		color: #c00;
		color: var(--a-active-text);
		text-decoration-color: #c00;
		text-decoration-color: var(--a-active-underline);
	}

	/* Backout above styling for W3C logo */
	.head p:not(.copyright):first-child > a,
	.head > a:first-child {
		border: none;
		text-decoration: none;
		background: transparent;
	}

/******************************************************************************/
/*                                    Images                                  */
/******************************************************************************/

	img {
		border-style: none;
	}

	/* For autogen numbers, add
	   .caption::before, figcaption::before { content: "Figure " counter(figure) ". "; }
	*/

	figure, .figure, .sidefigure {
		page-break-inside: avoid;
		text-align: center;
		margin: 2.5em 0;
	}
	.figure img,    .sidefigure img,    figure img,
	.figure object, .sidefigure object, figure object,
        .figure svg,    .sidefigure svg,    figure svg {
		max-width: 100%;
		margin: auto;
		height: auto;
	}
	.figure pre, .sidefigure pre, figure pre {
		text-align: left;
		display: table;
		margin: 1em auto;
	}
	.figure table, figure table {
		margin: auto;
	}
	@media screen and (min-width: 20em) {
		.sidefigure {
			float: right;
			width: 50%;
			margin: 0 0 0.5em 0.5em;
		}
	}
	.caption, figcaption, caption {
		font-style: italic;
		font-size: 90%;
	}
	.caption::before, figcaption::before, figcaption > .marker {
		font-weight: bold;
	}
	.caption, figcaption {
		counter-increment: figure;
	}

	/* DL list is indented 2em, but figure inside it is not */
	dd > .figure, dd > figure { margin-left: -2em; }

/******************************************************************************/
/*                             Colored Boxes                                  */
/******************************************************************************/

	.issue, .note, .example, .advisement, blockquote,
	.amendment, .correction, .addition {
		padding: .5em;
		border: .5em;
		border-left-style: solid;
		page-break-inside: avoid;
		margin: 1em auto;
	}
	span.issue, span.note {
		padding: .1em .5em .15em;
		border-right-style: solid;
	}

	.note  > p:first-child,
	.issue > p:first-child,
	blockquote > :first-child,
	.amendment > p:first-child,
	.correction > p:first-child,
	.addition > p:first-child {
		margin-top: 0;
	}
	.note  > p:last-child,
	.issue > p:last-child,
	blockquote > :last-child,
	.amendment > p:last-child,
	.correction > p:last-child,
	.addition > p:last-child {
		margin-bottom: 0;
	}

	.issue::before, .issue > .marker,
	.example::before, .example > .marker,
	.note::before, .note > .marker,
	details.note > summary > .marker,
	.amendment::before, .amendment > .marker,
	details.amendment > summary > .marker,
	.correction::before, .correction > .marker,
	details.correction > summary > .marker,
	.addition::before, .addition > .marker,
	details.addition > summary > .marker {
		text-transform: uppercase;
		padding-right: 1em;
	}

	.example::before, .example > .marker {
		display: block;
		padding-right: 0em;
	}

/** Blockquotes ***************************************************************/

	blockquote {
		border-color: silver;
		border-color: var(--blockquote-border);
		background: var(--blockquote-bg);
		color: var(--blockquote-text);
	}

/** Open issue ****************************************************************/

	.issue {
		border-color: #e05252;
		border-color: var(--issue-border);
		background: #fbe9e9;
		background: var(--issue-bg);
		color: black;
		color: var(--issue-text);
		counter-increment: issue;
		overflow: auto;
	}
	.issue::before, .issue > .marker {
		color: #831616;
		color: var(--issueheading-text);
	}
	/* Add .issue::before { content: "Issue " counter(issue) " "; } for autogen numbers,
	   or use class="marker" to mark up the issue number in source. */

/** Example *******************************************************************/

	.example {
		border-color: #e0cb52;
		border-color: var(--example-border);
		background: #fcfaee;
		background: var(--example-bg);
		color: black;
		color: var(--example-text);
		counter-increment: example;
		overflow: auto;
		clear: both;
	}
	.example::before, .example > .marker {
		color: #574b0f;
		color: var(--exampleheading-text);
	}
	/* Add .example::before { content: "Example " counter(example) " "; } for autogen numbers,
	   or use class="marker" to mark up the example number in source. */

/** Non-normative Note ********************************************************/

	.note {
		border-color: #52e052;
		border-color: var(--note-border);
		background: #e9fbe9;
		background: var(--note-bg);
		color: black;
		color: var(--note-text);
		overflow: auto;
	}

	.note::before, .note > .marker,
	details.note > summary {
		color: hsl(120, 70%, 22%);
		color: var(--noteheading-text);
	}
	/* Add .note::before { content: "Note "; } for autogen label,
	   or use class="marker" to mark up the label in source. */

	details.note[open] > summary {
		border-bottom: 1px silver solid;
		border-bottom: 1px var(--notesummary-underline) solid;
	}

/** Advisement Box ************************************************************/
	/*  for attention-grabbing normative statements */

	.advisement {
		border-color: orange;
		border-color: var(--advisement-border);
		border-style: none solid;
		background: #fec;
		background: var(--advisement-bg);
		color: black;
		color: var(--advisement-text);
	}
	strong.advisement {
		display: block;
		text-align: center;
	}
	.advisement::before, .advisement > .marker {
		color: #b35f00;
		color: var(--advisementheading-text);
	}

/** Amendment Box *************************************************************/

	.amendment, .correction, .addition {
		border-color: #330099;
		border-color: var(--amendment-border);
		background: #F5F0FF;
		background: var(--amendment-bg);
	}
	.amendment.proposed, .correction.proposed, .addition.proposed {
		border-style: solid;
		border-block-width: 0.25em;
	}
	.amendment::before, .amendment > .marker,
	details.amendment > summary::before, details.amendment > summary > .marker,
	.correction::before, .correction > .marker,
	details.correction > summary::before, details.correction > summary > .marker,
	.addition::before, .addition > .marker,
	details.addition > summary::before, details.addition > summary > .marker {
		color: #220066;
		color: var(--amendmentheading-text);
	}
	.amendment.proposed::before, .amendment.proposed > .marker,
	details.amendment.proposed > summary::before, details.amendment.proposed > summary > .marker,
	.correction.proposed::before, .correction.proposed > .marker,
	details.correction.proposed > summary::before, details.correction.proposed > summary > .marker,
	.addition.proposed::before, .addition.proposed > .marker,
	details.addition.proposed > summary::before, details.addition.proposed > summary > .marker {
		font-weight: bold;
	}

/** Spec Obsoletion Notice ****************************************************/
	/* obnoxious obsoletion notice for older/abandoned specs. */

	details:not([hidden]) {
		display: block;
	}
	summary {
		font-weight: bolder;
	}

	.annoying-warning:not(details),
	details.annoying-warning:not([open]) > summary,
	details.annoying-warning[open] {
		background: hsla(40,100%,50%,0.95);
		background: var(--warning-bg);
		color: black;
		color: var(--warning-text);
		padding: .75em 1em;
		border: red;
		border: var(--warning-border);
		border-style: solid none;
		box-shadow: 0 2px 8px black;
		text-align: center;
	}
	.annoying-warning :last-child {
		margin-bottom: 0;
	}

@media not print {
	details.annoying-warning[open] {
		position: fixed;
		left: 0;
		right: 0;
		bottom: 2em;
		z-index: 1000;
	}
}

	details.annoying-warning:not([open]) > summary {
		text-align: center;
	}

/** Entity Definition Boxes ***************************************************/

	.def {
		padding: .5em 1em;
		background: #def;
		background: var(--def-bg);
		margin: 1.2em 0;
		border-left: 0.5em solid #8ccbf2;
		border-left: 0.5em solid var(--def-border);
		color: black;
		color: var(--def-text);
	}

/******************************************************************************/
/*                                    Tables                                  */
/******************************************************************************/

	th, td {
		text-align: left;
		text-align: start;
	}

/** Property/Descriptor Definition Tables *************************************/

	table.def {
		/* inherits .def box styling, see above */
		width: 100%;
		border-spacing: 0;
	}

	table.def td,
	table.def th {
		padding: 0.5em;
		vertical-align: baseline;
		border-bottom: 1px solid #bbd7e9;
		border-bottom: 1px solid var(--defrow-border);
	}

	table.def > tbody > tr:last-child th,
	table.def > tbody > tr:last-child td {
		border-bottom: 0;
	}

	table.def th {
		font-style: italic;
		font-weight: normal;
		padding-left: 1em;
		width: 3em;
	}

	/* For when values are extra-complex and need formatting for readability */
	table td.pre {
		white-space: pre-wrap;
	}

	/* A footnote at the bottom of a def table */
	table.def td.footnote {
		padding-top: 0.6em;
	}
	table.def td.footnote::before {
		content: " ";
		display: block;
		height: 0.6em;
		width: 4em;
		border-top: thin solid;
	}

/** Data tables (and properly marked-up index tables) *************************/
	/*
		 <table class="data"> highlights structural relationships in a table
		 when correct markup is used (e.g. thead/tbody, th vs. td, scope attribute)

		 Use class="complex data" for particularly complicated tables --
		 (This will draw more lines: busier, but clearer.)

		 Use class="long" on table cells with paragraph-like contents
		 (This will adjust text alignment accordingly.)
		 Alternately use class="longlastcol" on tables, to have the last column assume "long".
	*/

	table {
		word-wrap: normal;
		overflow-wrap: normal;
		hyphens: manual;
	}

	table.data,
	table.index {
		margin: 1em auto;
		border-collapse: collapse;
		border: hidden;
		width: 100%;
	}
	table.data caption,
	table.index caption {
		max-width: 50em;
		margin: 0 auto 1em;
	}

	table.data td,  table.data th,
	table.index td, table.index th {
		padding: 0.5em 1em;
		border-width: 1px;
		border-color: silver;
		border-color: var(--datacell-border);
		border-top-style: solid;
	}

	table.data thead td:empty {
		padding: 0;
		border: 0;
	}

	table.data  thead,
	table.index thead,
	table.data  tbody,
	table.index tbody {
		border-bottom: 2px solid;
	}

	table.data colgroup,
	table.index colgroup {
		border-left: 2px solid;
	}

	table.data  tbody th:first-child,
	table.index tbody th:first-child  {
		border-right: 2px solid;
		border-top: 1px solid silver;
		border-top: 1px solid var(--datacell-border);
		padding-right: 1em;
	}

	table.data th[colspan],
	table.data td[colspan] {
		text-align: center;
	}

	table.complex.data th,
	table.complex.data td {
		border: 1px solid silver;
		border: 1px solid var(--datacell-border);
		text-align: center;
	}

	table.data.longlastcol td:last-child,
	table.data td.long {
	 vertical-align: baseline;
	 text-align: left;
	}

	table.data img {
		vertical-align: middle;
	}


/*
Alternate table alignment rules

	table.data,
	table.index {
		text-align: center;
	}

	table.data  thead th[scope="row"],
	table.index thead th[scope="row"] {
		text-align: right;
	}

	table.data  tbody th:first-child,
	table.index tbody th:first-child  {
		text-align: right;
	}

Possible extra rowspan handling

	table.data  tbody th[rowspan]:not([rowspan='1']),
	table.index tbody th[rowspan]:not([rowspan='1']),
	table.data  tbody td[rowspan]:not([rowspan='1']),
	table.index tbody td[rowspan]:not([rowspan='1']) {
		border-left: 1px solid silver;
	}

	table.data  tbody th[rowspan]:first-child,
	table.index tbody th[rowspan]:first-child,
	table.data  tbody td[rowspan]:first-child,
	table.index tbody td[rowspan]:first-child{
		border-left: 0;
		border-right: 1px solid silver;
	}
*/

/******************************************************************************/
/*                                  Indices                                   */
/******************************************************************************/


/** Table of Contents *********************************************************/

	.toc a {
		color: black;
		color: var(--toclink-text);
		/* More spacing; use padding to make it part of the click target. */
		padding: 0.1rem 1px 0;
		/* Larger, more consistently-sized click target */
		display: block;
		/* Switch to using border-bottom */
		text-decoration: none;
		border-bottom: 3px solid transparent;
		margin-bottom: -2px;
	}
	.toc a:visited {
		color: black;
		color: var(--toclink-visited-text);
	}
	.toc a:focus,
	.toc a:hover {
		background: #f8f8f8;
		background: rgba(75%, 75%, 75%, .25);
		background: var(--a-hover-bg);
		border-bottom-color: #3980b5;
		border-bottom-color: var(--toclink-underline);
	}
	.toc a:visited:focus,
	.toc a:visited:hover {
		border-bottom-color: #054572;
		border-bottom-color: var(--toclink-visited-underline);
	}

	.toc, .toc ol, .toc ul, .toc li {
		list-style: none; /* Numbers must be inlined into source */
		/* because generated content isn't search/selectable and markers can't do multilevel yet */
		margin:  0;
		padding: 0;
	}
	.toc {
		line-height: 1.1em; /* consistent spacing */
	}

	/* ToC not indented until third level, but font style & margins show hierarchy */
	.toc > li             { font-weight: bold;   }
	.toc > li li          { font-weight: normal; }
	.toc > li li li       { font-size:   95%;    }
	.toc > li li li li    { font-size:   90%;    }
	.toc > li li li li li { font-size:   85%;    }

	.toc > li             { margin: 1.5rem 0;    }
	.toc > li li          { margin: 0.3rem 0;    }
	.toc > li li li       { margin-left: 2rem;   }

	/* Section numbers in a column of their own */
	.toc .secno {
		float: left;
		width: 4rem;
		white-space: nowrap;
	}
	.toc > li li li li .secno {
		font-size: 85%;
	}
	.toc > li li li li li .secno {
		font-size: 100%;
	}

	:not(li) > .toc              { margin-left:  5rem; }
	.toc .secno                  { margin-left: -5rem; }
	.toc > li li li .secno       { margin-left: -7rem; }
	.toc > li li li li .secno    { margin-left: -9rem; }
	.toc > li li li li li .secno { margin-left: -11rem; }

	/* Tighten up indentation in narrow ToCs */
	@media (max-width: 30em) {
		:not(li) > .toc              { margin-left:  4rem; }
		.toc .secno                  { margin-left: -4rem; }
		.toc > li li li              { margin-left:  1rem; }
		.toc > li li li .secno       { margin-left: -5rem; }
		.toc > li li li li .secno    { margin-left: -6rem; }
		.toc > li li li li li .secno { margin-left: -7rem; }
	}
	@media screen and (min-width: 78em) {
		body:not(.toc-inline) :not(li) > .toc              { margin-left:  4rem; }
		body:not(.toc-inline) .toc .secno                  { margin-left: -4rem; }
		body:not(.toc-inline) .toc > li li li              { margin-left:  1rem; }
		body:not(.toc-inline) .toc > li li li .secno       { margin-left: -5rem; }
		body:not(.toc-inline) .toc > li li li li .secno    { margin-left: -6rem; }
		body:not(.toc-inline) .toc > li li li li li .secno { margin-left: -7rem; }
	}
	body.toc-sidebar #toc :not(li) > .toc              { margin-left:  4rem; }
	body.toc-sidebar #toc .toc .secno                  { margin-left: -4rem; }
	body.toc-sidebar #toc .toc > li li li              { margin-left:  1rem; }
	body.toc-sidebar #toc .toc > li li li .secno       { margin-left: -5rem; }
	body.toc-sidebar #toc .toc > li li li li .secno    { margin-left: -6rem; }
	body.toc-sidebar #toc .toc > li li li li li .secno { margin-left: -7rem; }

	.toc li {
		clear: both;
	}


/** Index *********************************************************************/

	/* Index Lists: Layout */
	ul.index       { margin-left: 0; columns: 15em; text-indent: 1em hanging; }
	ul.index li    { margin-left: 0; list-style: none; break-inside: avoid; }
	ul.index li li { margin-left: 1em; }
	ul.index dl    { margin-top: 0; }
	ul.index dt    { margin: .2em 0 .2em 20px;}
	ul.index dd    { margin: .2em 0 .2em 40px;}
	/* Index Lists: Typography */
	ul.index ul,
	ul.index dl { font-size: smaller; }
	@media not print {
		ul.index li a + span {
			white-space: nowrap;
			color: transparent;
		}
		ul.index li a:hover + span,
		ul.index li a:focus + span {
			color: #707070;
			color: var(--indexinfo-text);
		}
	}

/** Index Tables *****************************************************/
	/* See also the data table styling section, which this effectively subclasses */

	table.index {
		font-size: small;
		border-collapse: collapse;
		border-spacing: 0;
		text-align: left;
		margin: 1em 0;
	}

	table.index td,
	table.index th {
		padding: 0.4em;
	}

	table.index tr:hover td:not([rowspan]),
	table.index tr:hover th:not([rowspan]) {
		color: black;
		color: var(--indextable-hover-text);
		background: #f7f8f9;
		background: var(--indextable-hover-bg);
	}

	/* The link in the first column in the property table (formerly a TD) */
	table.index th:first-child a {
		font-weight: bold;
	}

/** Unicode characters and character sequences *******************************/

	.codepoint bdi {
		line-height: 1em;
		font-size: 1.25em;
		padding-inline: 0.25em;
	}

	.codepoint img {
		height: 2em;
		margin-inline: 0.25em;
		vertical-align: bottom;
	}

	.uname {
		font-family: Arial, monospace;
		font-size: 0.75em;
		letter-spacing: 0.03em;
		color: brown;
	}

/** Outdated warning **********************************************************/

.outdated-spec {
	color: black;
	color: var(--outdatedspec-text);
	background-color: rgba(0,0,0,0.5);
	background-color: var(--outdatedspec-bg);
}

.outdated-warning {
	position: fixed;
	bottom: 50%;
	left: 0;
	right: 0;
	margin: 0 auto;
	width: 50%;
	background: maroon;
	background: var(--outdated-bg);
	color: white;
	color: var(--outdated-text);
	border-radius: 1em;
	box-shadow: 0 0 1em red;
	box-shadow: 0 0 1em var(--outdated-shadow);
	padding: 2em;
	text-align: center;
	z-index: 2;
}

.outdated-warning a {
	color: currentcolor;
	background: transparent;
}

.edited-rec-warning {
	background: darkorange;
	background: var(--editedrec-bg);
	box-shadow: 0 0 1em;
}

.outdated-warning button {
	position: absolute;
	top: 0;
	right:0;
	margin: 0;
	border: 0;
	padding: 0.25em 0.5em;
	background: transparent;
	color: white;
	color: var(--outdated-text);
	font:1em sans-serif;
	text-align:center;
}

.outdated-warning span {
	display: block;
}

.outdated-collapsed {
	bottom: 0;
	border-radius: 0;
	width: 100%;
	padding: 0;
}

/******************************************************************************/
/*                                    Print                                   */
/******************************************************************************/

	@media print {
		/* Pages have their own margins. */
		html {
			margin: 0;
		}
		/* Serif for print. */
		body {
			font-family: serif;
		}

		.outdated-warning {
			position: absolute;
			border-style: solid;
			border-color: red;
		}

		.outdated-warning input {
			display: none;
		}
	}
	@page {
		margin: 1.5cm 1.1cm;
	}

/******************************************************************************/
/*                                    Legacy                                  */
/******************************************************************************/

	/* This rule is inherited from past style sheets. No idea what it's for. */
	.hide { display: none; }



/******************************************************************************/
/*                             Overflow Control                               */
/******************************************************************************/

	.figure .caption, .sidefigure .caption, figcaption {
		/* in case figure is overlarge, limit caption to 50em */
		max-width: 50rem;
		margin-left: auto;
		margin-right: auto;
	}
	.overlarge {
		/* Magic to create good item positioning:
		   "content column" is 50ems wide at max; less on smaller screens.
		   Extra space (after ToC + content) is empty on the right.

		   1. When item < content column, centers item in column.
		   2. When content < item < available, left-aligns.
		   3. When item > available, fills available and is scrollable.
		*/
		display: grid;
		grid-template-columns: minmax(0, 50em);
	}
	.overlarge > table {
		/* limit preferred width of table */
		max-width: 50em;
		margin-left: auto;
		margin-right: auto;
	}

	@media (min-width: 55em) {
		.overlarge {
			margin-right: calc(13px + 26.5rem - 50vw);
			max-width: none;
		}
	}
	@media screen and (min-width: 78em) {
		body:not(.toc-inline) .overlarge {
			/* 30.5em body padding 50em content area */
			margin-right: calc(40em - 50vw) !important;
		}
	}
	@media screen and (min-width: 90em) {
		body:not(.toc-inline) .overlarge {
			/* 4em html margin 30.5em body padding 50em content area */
			margin-right: calc(84.5em - 100vw) !important;
		}
	}

	@media not print {
		.overlarge {
			overflow-x: auto;
			/* See Lea Verou's explanation background-attachment:
			 * http://lea.verou.me/2012/04/background-attachment-local/
			 *
			background: top left  / 4em 100% linear-gradient(to right,  #ffffff, rgba(255, 255, 255, 0)) local,
			            top right / 4em 100% linear-gradient(to left, #ffffff, rgba(255, 255, 255, 0)) local,
			            top left  / 1em 100% linear-gradient(to right,  #c3c3c5, rgba(195, 195, 197, 0)) scroll,
			            top right / 1em 100% linear-gradient(to left, #c3c3c5, rgba(195, 195, 197, 0)) scroll,
			            white;
			background-repeat: no-repeat;
			*/
		}
	}

/******************************************************************************/
/*                             Dark mode toggle                               */
/******************************************************************************/

	#toc-theme-toggle input {
		position: absolute;
		clip: rect(1px, 1px, 1px, 1px);
		clip-path: inset(0px 0px 99.9% 99.9%);
		overflow: hidden;
		height: 1px;
		width: 1px;
		padding: 0;
		border: 0;
	}

	#toc-theme-toggle img {
		background-color: transparent;
        }

	#toc-theme-toggle span {
		padding: 5px;
		border-radius: 30px;
	}

	#toc-theme-toggle input:checked + span {
		background-color: var(--logo-bg);
		color: var(--logo-text);
		padding: 3px 10px;
	}

	@media (prefers-reduced-motion: reduce) {
		body.toc-sidebar #toc {
			position: absolute;
			overflow: initial;
			bottom: unset;
		}
	}

/* dark theme */
@media (prefers-color-scheme: dark) {
    :root {
        --text: #ddd;
        --bg: black;

        --logo-bg: #1a5e9a;
        --logo-active-bg: #c00;
        --logo-text: white;

        --tocnav-normal-text: #999;
        --tocnav-normal-bg: var(--bg);
        --tocnav-hover-text: var(--tocnav-normal-text);
        --tocnav-hover-bg: #080808;
        --tocnav-active-text: #f44;
        --tocnav-active-bg: var(--tocnav-normal-bg);

        --tocsidebar-text: var(--text);
        --tocsidebar-bg: #080808;
        --tocsidebar-shadow: rgba(255,255,255,.1);
        --tocsidebar-heading-text: hsla(203,20%,40%,.7);

        --toclink-text: var(--text);
        --toclink-underline: #6af;
        --toclink-visited-text: var(--toclink-text);
        --toclink-visited-underline: #054572;

        --heading-text: #8af;

        --hr-text: var(--text);

        --algo-border: #456;

        --del-text: #f44;
        --del-bg: transparent;
        --ins-text: #4a4;
        --ins-bg: transparent;

        --a-normal-text: #6af;
        --a-normal-underline: #555;
        --a-visited-text: var(--a-normal-text);
        --a-visited-underline: var(--a-normal-underline);
        --a-hover-bg: rgba(25%, 25%, 25%, .2);
        --a-active-text: #f44;
        --a-active-underline: var(--a-active-text);

        --borderedblock-bg: rgba(255, 255, 255, .05);

        --blockquote-border: silver;
        --blockquote-bg: var(--borderedblock-bg);
        --blockquote-text: currentcolor;

        --issue-border: #e05252;
        --issue-bg: var(--borderedblock-bg);
        --issue-text: var(--text);
        --issueheading-text: hsl(0deg, 70%, 70%);

        --example-border: hsl(50deg, 90%, 60%);
        --example-bg: var(--borderedblock-bg);
        --example-text: var(--text);
        --exampleheading-text: hsl(50deg, 70%, 70%);

        --note-border: hsl(120deg, 100%, 35%);
        --note-bg: var(--borderedblock-bg);
        --note-text: var(--text);
        --noteheading-text: hsl(120, 70%, 70%);
        --notesummary-underline: silver;

        --assertion-border: #444;
        --assertion-bg: var(--borderedblock-bg);
        --assertion-text: var(--text);

        --advisement-border: orange;
        --advisement-bg: #222218;
        --advisement-text: var(--text);
        --advisementheading-text: #f84;

        --warning-border: red;
        --warning-bg: hsla(40,100%,20%,0.95);
        --warning-text: var(--text);

        --amendment-border: #330099;
        --amendment-bg: #080010;
        --amendment-text: var(--text);
        --amendmentheading-text: #cc00ff;

        --def-border: #8ccbf2;
        --def-bg: #080818;
        --def-text: var(--text);
        --defrow-border: #136;

        --datacell-border: silver;

        --indexinfo-text: #aaa;

        --indextable-hover-text: var(--text);
        --indextable-hover-bg: #181818;

        --outdatedspec-bg: rgba(255, 255, 255, .5);
        --outdatedspec-text: black;
        --outdated-bg: maroon;
        --outdated-text: white;
        --outdated-shadow: red;

        --editedrec-bg: darkorange;
    }
    /* In case a transparent-bg image doesn't expect to be on a dark bg,
       which is quite common in practice... */
    img { background: white; }
}

/* add some counter */
.issue::before { content: "Issue " counter(issue) " "; }
.example::before { content: "Example " counter(example) " "; }
.note::before { content: "Note "; }
figcaption::before,
.caption::before { content: "Figure "  counter(figure) " ";  }

/* self-link for headline */
/* take from view-source:https://www.w3.org/TR/CSP3/ */
.heading, .issue, .note, .example, li, dt {
    position: relative;
}

a.self-link {
    position: absolute;
    top: 0;
    left: calc(-1 * (3.5rem - 26px));
    /* width: calc(3.5rem - 26px); */
    height: 2em;
    text-align: center;
    border: none;
    transition: opacity .2s;
    opacity: .5;
}
a.self-link:hover {
    opacity: 1;
}
.heading > a.self-link {
    font-size: 83%;
}
.example > a.self-link,
.note > a.self-link,
.issue > a.self-link {
    /* These blocks are overflow:auto, so positioning outside
       doesn't work. */
    left: auto;
    right: 0;
}
li > a.self-link {
    left: calc(-1 * (3.5rem - 26px) - 2em);
}
dfn > a.self-link {
    top: auto;
    left: auto;
    opacity: 0;
    width: 1.5em;
    height: 1.5em;
    background: var(--selflink-bg);
    color: var(--selflink-text);
    font-style: normal;
    transition: opacity .2s, background-color .2s, color .2s;
}
dfn:hover > a.self-link {
    opacity: 1;
}
dfn > a.self-link:hover {
    color: var(--selflink-hover-text);
}

a.self-link::before            { content: "Â¶"; }
.heading > a.self-link::before { content: "Â§"; }
dfn > a.self-link::before      { content: "#"; }

/* take from view-source:https://www.w3.org/TR/rdf12-concepts/ */
.self-link:hover{opacity:1;text-decoration:none;background-color:transparent}
aside.example .marker>a.self-link{color:inherit}
.header-wrapper{display:flex;align-items:baseline}
:is(h2,h3,h4,h5,h6):not(#toc>h2,#abstract>h2,#sotd>h2,.head>h2){position:relative;left:-.5em}
:is(h2,h3,h4,h5,h6):not(#toch2)+a.self-link{color:inherit;order:-1;position:relative;left:-1.1em;font-size:1rem;opacity:.5}
:is(h2,h3,h4,h5,h6)+a.self-link::before{content:"Â§";text-decoration:none;color:var(--heading-text)}
:is(h2,h3)+a.self-link{top:-.2em}
:is(h4,h5,h6)+a.self-link::before{color:#000}

/* org related style */
#home-and-up {
    position: fixed;
    z-index: 3;
    top: 0; right: 0.5em;
    margin: 0;
    min-height: 1.5em;
    font-size: 1.5em;
}
#home-and-up > a {
    padding: .1em 0.25em;
    margin: 0;
    border: none;
}

pre > code.src {
    display: block;
    padding: 1em;
    margin: .5em 0;
    overflow: auto;
    border-radius: 0;
    background: rgba(0, 0, 0, 0.03);
}

.org-center {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
}

img {
    max-width: 100%;
    height: auto;
}

.underline {
    text-decoration: underline;
}

/* source code highlight used by engrave-face.el */
.ef-h { color: #7f7f7f; }
.ef-sc { color: #a1db00; }
.ef-w { color: #ff8700; font-weight: 700; }
.ef-e { color: #ff4b4b; }
.ef-c { color: #b2b2b2; font-style: italic; }
.ef-cd { color: #b2b2b2; font-style: italic; }
.ef-s { color: #ff1f8b; }
.ef-d { color: #cc0000; }
.ef-m { color: #1f5bff; }
.ef-k { color: #00af00; }
.ef-b { color: #b218b2; }
.ef-f { color: #ef2929; }
.ef-v { color: #ff8700; }
.ef-t { color: #18b2b2; }
.ef-o { color: #1f5bff; }
.ef-wr { color: #cc0000; font-weight: 700; }
.ef-nc { color: #cc0000; }
.ef-pp { color: #b218b2; }
.ef-rc { color: #b218b2; }
.ef-rb { color: #ff8700; }

</style>
</head>
<body>
<div class="head">
<header>
<h1 id="title">yy-render &#x2014; Documentation</h1>
<p id="w3c-state"></p>
</header>
<details open>
<summary>More details about this document</summary>
<dl>
<dt>Create Date:</dt> <dd><time datetime="2024-07-07T13:59Z">[2024-07-07 21:59]</time></dd>
<dt>Publish Date:</dt> <dd><time datetime="2024-07-07T16:03Z">[2024-07-08 00:03]</time></dd>
<dt>Update Date:</dt> <dd>2024-10-15 17:19</dd>
<dt>Creator:</dt> <dd><a href="https://www.gnu.org/software/emacs/">Emacs</a> 29.2 (<a href="https://orgmode.org">Org</a> mode 9.6.15)</dd>
<dt>License:</dt> <dd>This work is licensed under <a href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a></dd>
</dl>
</details>
<hr>

</div>
<div id="abstract">
<p>
This document was written by include-yy and describes the functionalities of a
simple OBJ model render program. It specifically includes how to use the
program, how the program is implemented, and some details. This document
consists of the following sections:
</p>

<ol class="org-ol">
<li>Compilation and usage of the program</li>
<li>Implementation details of the program</li>
<li>Goals for further improvement</li>
</ol>
</div>
<nav id="toc">
<h2 id="table-of-contents">Table of Contents</h2>

<ul class="toc">
<li class="tocline"><a href="#abstract">About</a></li>
<li class="tocline"><a href="#orgnh-1"><span class="secno">1</span>Compilation and Usage</a>
<ul class="toc">
<li class="tocline"><a href="#orgnh-1.1"><span class="secno">1.1</span>Open New Models</a></li>
<li class="tocline"><a href="#orgnh-1.2"><span class="secno">1.2</span>Choose Different Shaders</a></li>
<li class="tocline"><a href="#orgnh-1.3"><span class="secno">1.3</span>Use Default Texture or Not</a></li>
</ul>
</li>
<li class="tocline"><a href="#orgnh-2"><span class="secno">2</span>Implementation Details</a>
<ul class="toc">
<li class="tocline"><a href="#orgnh-2.1"><span class="secno">2.1</span>General Overview</a></li>
<li class="tocline"><a href="#orgnh-2.2"><span class="secno">2.2</span>OBJ Model Loading</a>
<ul class="toc">
<li class="tocline"><a href="#orgnh-2.2.1"><span class="secno">2.2.1</span>Data Structure Design</a></li>
<li class="tocline"><a href="#orgnh-2.2.2"><span class="secno">2.2.2</span>Parsing Process</a></li>
<li class="tocline"><a href="#orgnh-2.2.3"><span class="secno">2.2.3</span>UTF-8 and UTF-16</a></li>
<li class="tocline"><a href="#orgnh-2.2.4"><span class="secno">2.2.4</span>Generating Triangles from Polygons</a></li>
<li class="tocline"><a href="#orgnh-2.2.5"><span class="secno">2.2.5</span>OBJ Loading Tests</a></li>
</ul>
</li>
<li class="tocline"><a href="#orgnh-2.3"><span class="secno">2.3</span>Implementation of YY-Render</a>
<ul class="toc">
<li class="tocline"><a href="#orgnh-2.3.1"><span class="secno">2.3.1</span>Win32 Window</a></li>
<li class="tocline"><a href="#orgnh-2.3.2"><span class="secno">2.3.2</span>Timer</a></li>
<li class="tocline"><a href="#orgnh-2.3.3"><span class="secno">2.3.3</span>Camera</a></li>
<li class="tocline"><a href="#orgnh-2.3.4"><span class="secno">2.3.4</span>Texture Image Loading</a></li>
<li class="tocline"><a href="#orgnh-2.3.5"><span class="secno">2.3.5</span>Rendering Implementation</a>
<ul class="toc">
<li class="tocline"><a href="#orgnh-2.3.5.1"><span class="secno">2.3.5.1</span>Message Handling</a></li>
<li class="tocline"><a href="#orgnh-2.3.5.2"><span class="secno">2.3.5.2</span>Resource Initialization</a></li>
<li class="tocline"><a href="#orgnh-2.3.5.3"><span class="secno">2.3.5.3</span>Command Sequence</a></li>
<li class="tocline"><a href="#orgnh-2.3.5.4"><span class="secno">2.3.5.4</span>Shaders</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="tocline"><a href="#orgnh-3"><span class="secno">3</span>Goals for Further Improvement</a></li>
</ul>
</nav>
<main>

<section id="orgnh-1"><div class="header-wrapper">
<h2 id="x-orgnh-1"><span class="secno">1. </span>Compilation and Usage</h2>
<a class="self-link" href="#orgnh-1" aria-label="Permalink for Section 1"></a>
</div>
<p>
After obtaining the entire project's source code, you can open the entire
project in <b>VS2022</b> by clicking on the SLN file in the project directory. Then,
compile the entire project by selecting Build Solution (Ctrl+Shift+B). You can
choose to use either the Debug or Release build target. After completing the
build, you can start the program by pressing F5 or Ctrl+F5. The screen after
launching looks roughly as follows:
</p>


<figure>
<img src="./img/1.png" alt="1.png">
</figure>

<p>
On a screen with a 60Hz refresh rate, the average frame rate over this period
will be displayed in the upper left corner of the window after about 10 seconds
(approximately 5 seconds for a 120Hz display). You can rotate the camera around
the character's center by pressing and dragging the left mouse button and zoom
in or out using the mouse scroll wheel. You can return to the initial position
by pressing the <code>ESC</code> key.
</p>

<p>
In addition to the basic movement methods, you can switch from mouse mode to
keyboard mode by pressing the <code>T</code> key (pressing it again will switch back to
mouse mode). In this mode, you can move forward/left/backward/right using <code>WASD</code>
and adjust the camera view with the arrow keys, where <code>â</code> corresponds to
looking up, <code>â</code> to looking down, <code>â</code> to looking left, and <code>â</code> to looking
right. In this mode, the operation is similar to the free view in some
first-person shooter games after death, except that view adjustment is done
using the arrow keys instead of the mouse.
</p>

<div class="note">



<p>
It is important to note that the mouse control and keyboard control use
completely separate transformation matrix parameters, so switching modes with
<code>T</code> will abruptly change the view to the other mode. Pressing <code>ESC</code> will reset
the state of all modes.
</p>

<p>
(In mouse mode (the default mode), pressing and dragging the right mouse button
can also change the view, but it moves slower than the left button, making it
suitable for precise operations.)
</p>

</div>

<p>
You can use <code>H</code> and <code>L</code> to rotate the light clockwise or counterclockwise; you
can use <code>J</code> and <code>K</code> to move the light source direction up or down.
</p>

<section id="orgnh-1.1"><div class="header-wrapper">
<h3 id="x-orgnh-1.1"><span class="secno">1.1. </span>Open New Models</h3>
<a class="self-link" href="#orgnh-1.1" aria-label="Permalink for Section 1.1"></a>
</div>
<p>
You can render a new OBJ model by selecting and opening an OBJ file through the
<code>Load</code> option in the application menu bar. Below is a schematic of the
interface, along with some example models:
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<tbody>
<tr>
<td><img src="./img/2.png" alt="2.png"></td>
<td><img src="./img/3.png" alt="3.png"></td>
</tr>
</tbody>
</table>

<p>
If the file opened is not an OBJ file or contains errors, yy-render will display
a MessageBox with detailed error information.
</p>

<p>
I have provided some OBJ models in the Models directory under the source code,
which can be used to test the program's functionality.
</p>


<figure>
<img src="./img/19.png" alt="19.png">
</figure>
</section>

<section id="orgnh-1.2"><div class="header-wrapper">
<h3 id="x-orgnh-1.2"><span class="secno">1.2. </span>Choose Different Shaders</h3>
<a class="self-link" href="#orgnh-1.2" aria-label="Permalink for Section 1.2"></a>
</div>
<p>
You can select one of the five Shaders from the <code>Shaders</code> option in the
application's menu bar, each of which achieves a different effect: using normal
vectors as color, using the map_Kd material as color, using the map_Ke material
as color, using Ka, Kd, Ks with the Phong lighting model, and finally, a Shader
that implements ShadowMap. The menu contents and the different effects are shown
in the images below:
</p>


<figure>
<img src="./img/4.png" alt="4.png">
<figcaption>Five different Shaders</figcaption>
</figure>


<figure>
<img src="./img/5.png" alt="5.png">
<figcaption>bunny under different Shaders</figcaption>
</figure>
</section>

<section id="orgnh-1.3"><div class="header-wrapper">
<h3 id="x-orgnh-1.3"><span class="secno">1.3. </span>Use Default Texture or Not</h3>
<a class="self-link" href="#orgnh-1.3" aria-label="Permalink for Section 1.3"></a>
</div>
<p>
When an OBJ model does not have a material, yy-render provides a default
texture, which comes from the teapot in the <a href="https://casual-effects.com/data/">McGuire Computer Graphics
Archive</a>. You can choose to use or not use the default texture through the <code>use
default diffuse texture</code> option in the Options dropdown menu in the menu bar:
</p>


<figure>
<img src="./img/6.png" alt="6.png">
</figure>

<div class="note">



<p>
This option is only applicable for the last two Shaders.
</p>

</div>
</section>
</section>

<section id="orgnh-2"><div class="header-wrapper">
<h2 id="x-orgnh-2"><span class="secno">2. </span>Implementation Details</h2>
<a class="self-link" href="#orgnh-2" aria-label="Permalink for Section 2"></a>
</div>
<p>
This section introduces the structure of the entire yy-render codebase and
explains some implementation details, aiming to assist those who read the code.
</p>

<section id="orgnh-2.1"><div class="header-wrapper">
<h3 id="x-orgnh-2.1"><span class="secno">2.1. </span>General Overview</h3>
<a class="self-link" href="#orgnh-2.1" aria-label="Permalink for Section 2.1"></a>
</div>
<p>
The yy-render solution consists of three projects: the OBJ loading module yyobj,
the yyobj_test project for testing yyobj, and the application project YY-Render
that utilizes yyobj. Their directory structure is shown in the image below:
</p>


<figure>
<img src="./img/7.png" alt="7.png">
</figure>

<ul class="org-ul">
<li>The yyobj project's main function is to read the contents of OBJ files and MTL
files and convert them into data structures that can be directly used.</li>
<li>The yyobj_test project conducts unit tests on yyobj and tests the reading
using existing OBJ models.</li>
<li>The YY-Render project implements the yy-render application. Its main functions
include the implementation of the window, the implementation of the camera,
and the calls to the DX12 API.</li>
</ul>
</section>

<section id="orgnh-2.2"><div class="header-wrapper">
<h3 id="x-orgnh-2.2"><span class="secno">2.2. </span>OBJ Model Loading</h3>
<a class="self-link" href="#orgnh-2.2" aria-label="Permalink for Section 2.2"></a>
</div>
<p>
For parsing OBJ files, we could consider using a dedicated parser generator to
create parsers for OBJ and MTL files. However, since the format of OBJ files is
very simple and there are only a few context-sensitive keywords in the parsing
process, such as <code>g</code>, <code>o</code>, and <code>s</code>, implementing an OBJ loader from scratch is
not very difficult. However, achieving efficiency, error-friendliness, and
comprehensive features is not an easy task, which means we need extensive
testing, writing low-level code, and studying the standard documentation for the
files.
</p>

<p>
When I started the implementation, I referred to <a href="https://github.com/Bly7/OBJ-Loader">Bly7/OBJ-Loader</a>, which uses
<code>std::string</code> and <code>fstream</code> for string processing and file I/O. Its
implementation is very straightforward, but the downside is its low
performance. This is mainly because it processes the contents of OBJ files line
by line, and the short context leads to overly frequent function calls,
resulting in significant performance overhead. In Debug mode, where functions
are not inlined, there is about a tenfold performance difference between Debug
and Release. <a href="https://github.com/thisistherk/fast_obj">thisistherk/fast_obj</a> reads a large chunk of file content at once
and processes it byte-by-byte using pointer operations, greatly reducing
function call overhead. <a href="https://github.com/guybrush77/rapidobj">guybrush77/rapidobj</a> even implements multithreaded
reading, achieving several times the performance improvement over
fast_obj. However, its code is much more complex than that of fast_obj, making
it not an easy learning target.
</p>

<p>
In a sense, my implementation of yyobj is a hybrid of the three: I borrowed the
data structures from fast_obj, the error handling and polygon-to-triangle
splitting algorithm from rapidobj, and the normal vector generation method from
OBJ-Loader. The proportions of these three components might be around 85%, 10%,
and 5%, respectively.
</p>

<p>
yyobj supports only a portion of the OBJ standard. It does not support keywords
such as <code>l</code>, <code>curv</code>, <code>curv2</code>, <code>surf</code>, etc., and it also does not support the <code>-</code>
options in MTL files, such as <code>-o</code>, <code>-s</code>, and so on.
</p>

<section id="orgnh-2.2.1"><div class="header-wrapper">
<h4 id="x-orgnh-2.2.1"><span class="secno">2.2.1. </span>Data Structure Design</h4>
<a class="self-link" href="#orgnh-2.2.1" aria-label="Permalink for Section 2.2.1"></a>
</div>
<p>
As we know, standalone vertex data comes in three types, which are <code>v</code>, <code>vt</code>,
and <code>vn</code>, representing position, texture coordinates, and normal vectors,
respectively. Since they appear sequentially in OBJ files as line items, using
<code>std::vector&lt;float&gt;</code> as the container for these points is very suitable.
</p>

<p>
The <code>f</code> keyword can combine different types of vertex data to form faces, and
the number of vertices per face is at least 3. Since the number of vertices per
face is not fixed, we could consider using a structure like
<code>std::vector&lt;std::vector&lt;VertexIndex&gt;&gt;</code> to store them. However, this is not
contiguous and is therefore not cache-friendly. A more reasonable data structure
is to construct an array with each vertex in <code>f</code> as a unit and then use a
<code>faces-vs</code> array to record the number of vertices per face:
</p>


<figure>
<img src="./img/8.png" alt="8.png">
</figure>

<p>
When handling the two grouping keywords <code>g</code> and <code>o</code>, we can record their
starting positions and the total number of faces in the <code>f</code> vector and the
<code>faces-vs</code> vector to mark their scope. Since this task hardly involves
operations related to grouping, we don't need to focus too much on the grouping
of <code>o</code> and <code>g</code> but rather on the material partitioning of <code>usemtl</code>. <code>usemtl</code> can
be recorded in the same way as <code>o</code> and <code>g</code>, and its record is actually the most
useful part: it can be used to determine the vertex group information with
different materials when rendering vertices.
</p>

<p>
For materials, we can use a single vector to record textures and store the
offset of the texture vector in the material's corresponding data
structure. This way, multiple materials can share the same texture, avoiding
redundant texture loading and saving space.
</p>

<p>
In the yyobj project, the definitions of the data structures are located in the
ObjWave.h header file.
</p>
</section>

<section id="orgnh-2.2.2"><div class="header-wrapper">
<h4 id="x-orgnh-2.2.2"><span class="secno">2.2.2. </span>Parsing Process</h4>
<a class="self-link" href="#orgnh-2.2.2" aria-label="Permalink for Section 2.2.2"></a>
</div>
<p>
Since OBJ files are line-based and the context is very simple, we dispatch the
remaining parsing functions to specialized functions based on the keyword
obtained from the beginning of the line. These functions take a starting
pointer, process the parsing task corresponding to the keyword, and then move
the pointer to the end, serving as the starting position for the next parsing
task. All line-by-line parsing functions have the following signature:
</p>


<figure>
<img src="./img/9.png" alt="9.png">
</figure>

<p>
Among these functions, <code>parse_buffer</code> is responsible for dispatching; it
allocates tasks to different functions like <code>parse_vertex</code> based on the keyword
at the beginning of the line. <code>parse_buffer</code> itself is a massive <code>switch-case</code>
structure.
</p>

<p>
Since most of the parsing work for OBJ involves converting strings to
floating-point numbers of type <code>float</code>, improving the efficiency of this part is
crucial for overall efficiency. C++ itself provides functions like <code>std::atof</code>
and <code>strtof</code>. While reading the rapidobj source code, I found that it uses
<a href="https://github.com/fastfloat/fast_float">fastfloat/fast_float</a> to parse floating-point number strings. According to the
project's README, it offers a 4 to 10 times performance improvement over the
standard library. Based on my personal tests, <code>fast_float</code> is about twice as
fast as <code>strtof</code>, and I used it in yyobj to parse floating-point numbers.
</p>

<div class="amendment">



<p>
fast_obj is the fastest single-threaded parser. It also compiles pretty much
anywhere (any C compiler would do), but also has the least amount of
features. However, I could make it crash on syntax it does not support (\ line
continuation); it might be the least robust of the parsers.
</p>

<p>
<a href="https://aras-p.info/blog/2022/05/14/comparing-obj-parse-libraries/">https://aras-p.info/blog/2022/05/14/comparing-obj-parse-libraries/</a>
</p>

</div>

<p>
What if an error occurs during parsing? The approach of fast_obj is to ignore it
as much as possible or crash outright. rapidobj uses error codes to capture
possible errors during parsing and retains context information about where the
error occurred. yyobj follows the approach of rapidobj by assigning a unique
error code to all possible error locations. When an error occurs, the library
user can quickly locate and fix the error based on the error message
corresponding to the error code and the contextual information containing the
line number and the current line's string. You can check the enumeration class
<code>yyobj_errc</code> and the <code>Error</code> structure in ObjWave.h to understand the
definitions related to error handling. Below is a partial implementation of
<code>parse_vertex</code>, which returns the <code>ParseFloatError</code> error code when a
floating-point parsing error occurs. This error is noticed by <code>parse_buffer</code>,
and the current context information is recorded:
</p>


<figure>
<img src="./img/10.png" alt="10.png">
</figure>

<p>
Due to the additional error-handling code, yyobj is only half as fast as
fast_obj, but it is still sufficiently fast.
</p>
</section>

<section id="orgnh-2.2.3"><div class="header-wrapper">
<h4 id="x-orgnh-2.2.3"><span class="secno">2.2.3. </span>UTF-8 and UTF-16</h4>
<a class="self-link" href="#orgnh-2.2.3" aria-label="Permalink for Section 2.2.3"></a>
</div>
<p>
On Windows, the character type <code>wchar_t</code> has a length of 2, which can
accommodate a UTF-16 encoded character of length 2. However, UTF-8 encoding is
currently more popular. yyobj assumes that the files being read are UTF-8
encoded. In the Win32 API, functions ending with A indicate that they accept
traditional ASCII strings, while functions ending with W indicate that they
accept wide strings using UTF-16 â at least, that's what is written in the book
<i>Programming Windows</i>. However, the situation seems to have changed
recently. Microsoft has extended functions ending with A to accept UTF-8
strings, thereby providing system-level UTF-8 support (for more details, please
refer to <a href="https://learn.microsoft.com/en-us/windows/apps/design/globalizing/use-utf8-code-page">Use UTF-8 code pages in Windows apps</a>). In Windows 10, UTF-8 encoding
can be enabled globally through system locale settings, but we can also apply
UTF-8 encoding to a single application using a manifest.xml description
file. YY-Render uses manifest.xml to enable UTF-8.
</p>

<pre><code class="src src-xml">&lt;?xml version="1.0" encoding="UTF-8" standalone="yes"?&gt;
&lt;assembly manifestVersion=<span class="ef-s">"1.0"</span> xmlns=<span class="ef-s">"urn:schemas-microsoft-com:asm.v1"</span>&gt;
  &lt;assemblyIdentity type=<span class="ef-s">"win32"</span> name=<span class="ef-s">"..."</span> version=<span class="ef-s">"6.0.0.0"</span>/&gt;
  &lt;application&gt;
    &lt;windowsSettings&gt;
      &lt;activeCodePage&gt;UTF-8&lt;/activeCodePage&gt;
    &lt;/windowsSettings&gt;
  &lt;/application&gt;
&lt;/assembly&gt;</code></pre>

<p>
In this case, as long as the source code uses UTF-8 encoding, string literals
within the code will also be UTF-8 encoded, making such strings convenient to
use as file paths.
</p>
</section>

<section id="orgnh-2.2.4"><div class="header-wrapper">
<h4 id="x-orgnh-2.2.4"><span class="secno">2.2.4. </span>Generating Triangles from Polygons</h4>
<a class="self-link" href="#orgnh-2.2.4" aria-label="Permalink for Section 2.2.4"></a>
</div>
<p>
OBJ files allow faces with more than three vertices to be specified using the
<code>f</code> keyword. We can split this face into multiple triangles for consistent
rendering. If the polygon is convex, it can be divided in a very straightforward
manner, but if it is not, things get a bit tricky:
</p>


<figure>
<img src="./img/11.png" alt="11.png">
</figure>

<p>
If the polygon is convex, we can simply split it as shown on the left side of
the above image, such as 012, 023, 034, and so on. However, this approach does
not work for concave polygons. rapidobj uses a very clever method: it connects
two non-adjacent vertices pairwise and calculates the lengths of these two line
segments. If the line segment corresponding to the initial point <code>0</code> of the
triangle is longer, it indicates that the initial point should be changed to any
point on the other diagonal. In this case, the order will not be 012, 023 but
rather 013, 123.
</p>

<p>
For polygons with more sides, rapidobj provides a general solution. However, in
my implementation, I used a simpler approach: I assume that polygons with more
than four sides are convex. Since I have never encountered polygons with more
than four sides in OBJ files, this should be harmless.
</p>

<p>
The polygon splitting implementation in yyobj is located in the function
<code>Obj2Data</code>, which can be found at line 1243 in <code>ObjWave.cpp</code>.
</p>
</section>

<section id="orgnh-2.2.5"><div class="header-wrapper">
<h4 id="x-orgnh-2.2.5"><span class="secno">2.2.5. </span>OBJ Loading Tests</h4>
<a class="self-link" href="#orgnh-2.2.5" aria-label="Permalink for Section 2.2.5"></a>
</div>
<p>
To verify the correctness of my yyobj implementation, I wrote some unit tests
for most of the important parsing functions in the test project yyobj_test. You
can open the test dialog and run all tests using <code>Ctrl e t</code>:
</p>


<figure>
<img src="./img/12.png" alt="12.png">
</figure>
</section>
</section>

<section id="orgnh-2.3"><div class="header-wrapper">
<h3 id="x-orgnh-2.3"><span class="secno">2.3. </span>Implementation of YY-Render</h3>
<a class="self-link" href="#orgnh-2.3" aria-label="Permalink for Section 2.3"></a>
</div>
<p>
In this task, the code lines for yyobj and yyobj_test together account for about
half of the total lines of code, while the remaining half generally consists of
the DX12 implementation of a renderer that is not dependent on a specific
model. This part can be further subdivided into the following components:
</p>

<ul class="org-ul">
<li>Window handling code, which processes mouse and keyboard messages</li>
<li>Timer code, simulating the flow of time</li>
<li>Texture loading code, obtaining textures that can be loaded into the GPU from
images of different formats</li>
<li>Camera code, obtaining view transformation and projection transformation
matrices, and moving the camera in space</li>
<li>Rendering code, binding resources, and completing rendering</li>
</ul>

<p>
Among these components, the rendering part is more complex, and I will provide a
more detailed introduction. Since my understanding of DX12 is still quite basic,
the code might have a high degree of coupling.
</p>

<section id="orgnh-2.3.1"><div class="header-wrapper">
<h4 id="x-orgnh-2.3.1"><span class="secno">2.3.1. </span>Win32 Window</h4>
<a class="self-link" href="#orgnh-2.3.1" aria-label="Permalink for Section 2.3.1"></a>
</div>
<p>
The implementation of the window creation and window message handling functions
is located in W32.h and W32.cpp, which include the window initialization and
message loop code. Here, I expose the interface functions for message handling
through the class <code>W32Handler</code>. Subclasses can override these interfaces to
handle mouse and keyboard messages for the window:
</p>


<figure>
<img src="./img/13.png" alt="13.png">
</figure>

<p>
Apart from the interface class <code>W32Handler</code>, the remaining implementation of
W32.cpp comes from <a href="https://github.com/microsoft/DirectX-Graphics-Samples/blob/master/Samples/Desktop/D3D12DynamicIndexing/src/Win32Application.cpp">D3D12DynamicIndexing</a>. An interesting aspect of this
implementation is that it continuously calls the callback function by using
PeekMessage and not handling the WM_PAINT message in the message callback,
thereby achieving the effect of continuously refreshing the window and
rendering. However, this approach prevents us from creating modal child windows
(for details, refer to <a href="https://stackoverflow.com/questions/59471442/message-box-is-not-working-inside-wm-command-win32-api">Message Box is not working inside WM_COMMAND!</a>). To
address this, when creating a modal dialog, the callback function processes the
WM_PAINT message by passing it to DefWindowProc to handle the WM_PAINT, and then
InvalidRect is called after the modal dialog ends to regenerate WM_PAINT,
allowing the window to continue refreshing. For the specific implementation,
refer to <code>RunWithModal</code> in W32.h and the WM_PAINT message handling in the
callback function in W32.cpp.
</p>

<p>
<code>W32Handler</code> is inherited by <code>Framework</code> in Framework.h. This subclass
implements several convenient functions, such as obtaining the application
directory to locate resources, creating the HardwareAdapter, and setting the
window title.
</p>
</section>

<section id="orgnh-2.3.2"><div class="header-wrapper">
<h4 id="x-orgnh-2.3.2"><span class="secno">2.3.2. </span>Timer</h4>
<a class="self-link" href="#orgnh-2.3.2" aria-label="Permalink for Section 2.3.2"></a>
</div>
<p>
If we assume that the time interval between every two consecutive WM_PAINT
messages is equal, then the interval between each frame is a constant value. If
the screen refresh rate is assumed to be 60Hz, the interval would be
16.67ms. However, since the interval between frames cannot be a constant, we
need a timer to calculate the time difference between two frames to represent
the actual time elapsed.
</p>

<p>
Similarly, yy-render uses the timer from D3D12DynamicIndexing, which internally
uses <code>QueryPerformanceCounter</code> and <code>QueryPerformanceFrequency</code> (from <a href="https://learn.microsoft.com/en-us/windows/win32/api/profileapi/">profileapi</a>)
to obtain high-precision time.
</p>
</section>

<section id="orgnh-2.3.3"><div class="header-wrapper">
<h4 id="x-orgnh-2.3.3"><span class="secno">2.3.3. </span>Camera</h4>
<a class="self-link" href="#orgnh-2.3.3" aria-label="Permalink for Section 2.3.3"></a>
</div>
<p>
The basic camera code is also derived from the SimpleCamera in
D3D12DynamicIndexing, but I made some modifications and improvements based on
it. The original camera only supported keyboard operations and could only move
within the <code>y=0</code> plane. I improved it to allow movement along the <code>y</code> axis (up
and down) while moving forward/backward (W/S) based on the current pitch
angle. Additionally, I added mouse support to allow the camera to rotate around
the origin of the world coordinate system to change the view by dragging the
mouse. Keyboard movement and mouse movement are separate; here, I first
introduce the keyboard movement method.
</p>

<p>
In the world coordinate system, the camera's position can be represented using
DX12's <code>XMFLOAT3</code>. Its orientation can be measured using two angle values: the
yaw angle around the y-axis relative to the z-axis, and the pitch angle relative
to the xz-plane. As shown in the diagram below:
</p>


<figure>
<img src="./img/14.png" alt="14.png">
</figure>

<p>
In the camera space, we can move forward, backward, left, and right in the
<code>y'=0</code> plane using WASD. We only need to use the camera's position and angles to
obtain the displacement in world coordinates based on the displacement in camera
space. This part of the code can be found in the <code>SimpleCamera::Update</code> function
in SimpleCamera.cpp. With <code>XMMatrixLookToRH</code>, we can easily obtain the view
transformation matrix, which is located in the <code>SimpleCamera::GetViewMatrix</code>
function.
</p>

<p>
The logic for controlling the camera with the mouse is simpler. We also need to
record the yaw angle around the y-axis relative to the z-axis and the pitch
angle relative to the xz-plane. Using these angles and the camera's distance
from the origin, we can determine the camera's position. However, the camera's
orientation is constant, pointing towards the origin of the world coordinates. I
borrowed some code for handling mouse click and drag messages from "Introduction
to 3D Game Programming with DirectXÂ® 12," roughly located on page 263 of the
book. We can obtain the view transformation matrix for mouse mode using
<code>XMMatrixLookAtRH</code>.
</p>

<p>
I also placed the implementation of the light in the camera since we need to
control the direction of parallel light according to the task requirements. Its
implementation is very similar to the camera implementation in mouse mode.
</p>

<p>
Finally, when performing projection transformations, I used the bounding box of
the cube obtained from the model and, during the view transformation, determined
the maximum and minimum depth <code>z</code> coordinates based on the bounding box. These
two coordinates can be used to determine the near and far planes during the
projection transformation.
</p>
</section>

<section id="orgnh-2.3.4"><div class="header-wrapper">
<h4 id="x-orgnh-2.3.4"><span class="secno">2.3.4. </span>Texture Image Loading</h4>
<a class="self-link" href="#orgnh-2.3.4" aria-label="Permalink for Section 2.3.4"></a>
</div>
<p>
<a href="https://github.com/microsoft/DirectXTK">DirectXTK</a> and <a href="https://github.com/microsoft/DirectXTK12">DirectXTK12</a> provide image loading code using <a href="https://learn.microsoft.com/en-us/windows/win32/wic/-wic-api">WIC</a>, but their
excessive wrapping makes them unsuitable for direct use (more accurately,
yy-render is too simple and low-level to require such high-level APIs:
<a href="https://github.com/Microsoft/DirectXTK/wiki/WICTextureLoader#createwictexturefromfile">CreateWICTextureFromFile</a>).
</p>

<p>
While searching for code examples capable of rendering OBJ models, I found
<a href="https://github.com/Joon1221/DX12-object-loader">Joon1221/DX12-object-loader</a>, where the code might have been inspired by Frank
Luna's work. I made some improvements based on his code to read textures, and
the specific implementation can be found in LoadTexture.h and LoadTexture.cpp of
YY-Render.
</p>
</section>

<section id="orgnh-2.3.5"><div class="header-wrapper">
<h4 id="x-orgnh-2.3.5"><span class="secno">2.3.5. </span>Rendering Implementation</h4>
<a class="self-link" href="#orgnh-2.3.5" aria-label="Permalink for Section 2.3.5"></a>
</div>
<p>
The main implementation of yy-render is located in MyRender.h and MyRender.cpp
of the YY-Render project. In MyRender.h, there is a large subclass <code>MyRender</code>,
which inherits from the <code>Framework</code> class.
</p>

<section id="orgnh-2.3.5.1"><div class="header-wrapper">
<h5 id="x-orgnh-2.3.5.1"><span class="secno">2.3.5.1. </span>Message Handling</h5>
<a class="self-link" href="#orgnh-2.3.5.1" aria-label="Permalink for Section 2.3.5.1"></a>
</div>
<p>
<code>MyRender</code> overrides various message-handling methods of the base class
<code>W32Handler</code> and delegates them to the class member <code>m_camera</code>:
</p>


<figure>
<img src="./img/15.png" alt="15.png">
</figure>

<p>
<code>MyRender</code> implements its own handling of menu messages in the <code>OnCommand</code>
method in MyRender.cpp. The resource IDs for each menu item come from
Resource.h, where the resource ID generation uses an interesting <a href="https://mc-deltat.github.io/articles/stateful-metaprogramming-cpp20">compile-time
counter</a> rather than <code>__COUNTER__</code>.
</p>
</section>

<section id="orgnh-2.3.5.2"><div class="header-wrapper">
<h5 id="x-orgnh-2.3.5.2"><span class="secno">2.3.5.2. </span>Resource Initialization</h5>
<a class="self-link" href="#orgnh-2.3.5.2" aria-label="Permalink for Section 2.3.5.2"></a>
</div>
<p>
The <code>OnInit</code> method of <code>MyRender</code> initializes the necessary resources. It calls
<code>LoadPipeline</code>, <code>LoadAssetsOnce</code>, and <code>LoadAssets</code>; the first two functions
initialize resources unrelated to the OBJ model, while <code>LoadAssets</code> implements
the OBJ data loading functionality.
</p>

<p>
<code>LoadPipeline</code> performs the following tasks:
</p>

<ul class="org-ul">
<li>Calls <code>D3D12CreateDevice</code> to initialize the <code>m_device</code> of type <code>ID3D12Device</code></li>
<li>Checks for MSAA support and stores the result in the <code>m_useMSAA</code> member</li>
<li>Creates the swap chain</li>
<li>Creates the RTV, DSV, and SAMPLER descriptor heaps; note that the heap length
for DSV and SAMPLER is set to 2, preparing for the ShadowMap</li>
<li>If the current device supports MSAA, the number of RTVs will be 3, providing
an additional RTV for multi-sampling</li>
</ul>

<p>
<code>LoadAssetsOnce</code> performs the following tasks:
</p>

<ul class="org-ul">
<li>Creates the RootSignature</li>
<li>Creates the PipelineState objects containing all 5 Shaders</li>
<li>Creates the depth stencil view</li>
<li>Creates the sampler and the Fence</li>
<li>Creates the menu</li>
</ul>

<p>
The structure of the RootSignature is as follows:
</p>


<figure>
<img src="./img/16.png" alt="16.png">
</figure>

<p>
<code>c0</code> corresponds to the transformation matrices and some option values; refer to
the <code>SceneConstantBuffer</code> structure in MyRender.h for more details. <code>c1</code>
corresponds to the parameters of the MTL material, <code>s0~s8</code> correspond to all 9
possible textures in the MTL material, <code>t0/t1</code> correspond to two texture
samplers, with the former sampling regular textures and the latter sampling
ShadowMap depth textures; <code>s9</code> corresponds to the ShadowMap depth texture.
</p>

<p>
It is important to note that all PipelineState objects have
<code>FrontCounterClockwise</code> set to true because OBJ models use a right-handed
coordinate system, which has a triangle winding order opposite to the default
left-handed system in DX12. Additionally, I have not modified the default
CULL_MODE.
</p>


<figure>
<img src="./img/17.png" alt="17.png">
</figure>

<p>
<code>LoadAssets</code> performs the following tasks:
</p>

<ul class="org-ul">
<li>Loads the OBJ model resources using <code>yyobj</code></li>
<li>Loads texture image resources using <code>LoadTexture</code></li>
<li>Creates vertex resources and writes vertex data to the GPU</li>
<li>Adjusts the model transformation matrix based on the model, providing the
bounding box data for the camera</li>
<li>Updates texture and constant buffer heap descriptors</li>
<li>Creates constant buffer resources and writes material data to the GPU</li>
<li>Creates texture resources and writes textures to the GPU</li>
</ul>

<p>
A key aspect here is the fill order of resources in the heap descriptors, which
is shown in the following image:
</p>


<figure>
<img src="./img/18.png" alt="18.png">
</figure>
</section>

<section id="orgnh-2.3.5.3"><div class="header-wrapper">
<h5 id="x-orgnh-2.3.5.3"><span class="secno">2.3.5.3. </span>Command Sequence</h5>
<a class="self-link" href="#orgnh-2.3.5.3" aria-label="Permalink for Section 2.3.5.3"></a>
</div>
<p>
When the window receives a WM_PAINT message, it calls the <code>OnUpdate</code> and
<code>OnPaint</code> methods of the object pointed to by the <code>W32Handler</code> pointer. In the
MyRender class, <code>OnUpdate</code> is implemented to update the data of each member in
the <code>SceneConstBuffer</code>. <code>OnPaint</code> calls <code>PopulateCommandList</code> to populate the
command list. It is important to note the handling of MSAA and ShadowMap
generation in <code>PopulateCommandList</code>. If ShadowMap is being used, the scene is
first rendered using the light as the camera to create a shadow material,
followed by normal rendering. If MSAA is being used, rendering is first done to
a buffer that is not directly presented to the display screen, and then it is
downsampled to the RTV.
</p>

<p>
The implementations of MSAA and ShadowMap were primarily based on the following
references:
</p>

<ul class="org-ul">
<li><a href="https://valhally.xyz/index.php/2022/01/27/directx12-%e5%bc%80%e5%90%afmsaa/">https://valhally.xyz/index.php/2022/01/27/directx12-%e5%bc%80%e5%90%afmsaa/</a></li>
<li><a href="https://qiita.com/em7dfggbcadd9/items/eebe457bbe9186ea5f90">https://qiita.com/em7dfggbcadd9/items/eebe457bbe9186ea5f90</a></li>
</ul>
</section>

<section id="orgnh-2.3.5.4"><div class="header-wrapper">
<h5 id="x-orgnh-2.3.5.4"><span class="secno">2.3.5.4. </span>Shaders</h5>
<a class="self-link" href="#orgnh-2.3.5.4" aria-label="Permalink for Section 2.3.5.4"></a>
</div>
<p>
yy-render uses 5 shaders:
</p>

<ul class="org-ul">
<li>normal_color.hlsl: Uses the model's normals as the object's surface color.</li>
<li>mapKd_color.hlsl: Uses the diffuse map as the color.</li>
<li>mapKe_color.hlsl: Uses the emissive map as the color.</li>
<li>KaKdKs.hlsl: Uses the Phong model combined with material parameters to
generate color under parallel lighting.</li>
<li>Final_ShaderMap.hlsl: Adds ShadowMap support on top of the previous shader.</li>
</ul>

<p>
It is important to note that there are some issues with the selection of the
bias parameter for the ShadowMap, which might result in less-than-ideal shadow
effects.
</p>
</section>
</section>
</section>
</section>

<section id="orgnh-3"><div class="header-wrapper">
<h2 id="x-orgnh-3"><span class="secno">3. </span>Goals for Further Improvement</h2>
<a class="self-link" href="#orgnh-3" aria-label="Permalink for Section 3"></a>
</div>
<p>
Currently, yy-render cannot handle transparent objects. It might be worth
considering adding Order-Independent Transparency (OIT) support. The following
resources might be useful:
</p>

<ul class="org-ul">
<li><a href="https://webgpu.github.io/webgpu-samples/?sample=a-buffer#translucent.wgsl">https://webgpu.github.io/webgpu-samples/?sample=a-buffer#translucent.wgsl</a></li>
<li><a href="http://www.klayge.org/2013/02/18/%E7%BB%A7%E7%BB%AD%E6%8E%A2%E7%B4%A2oit%EF%BC%9Aadaptive-transparency/">http://www.klayge.org/2013/02/18/%E7%BB%A7%E7%BB%AD%E6%8E%A2%E7%B4%A2oit%EF%BC%9Aadaptive-transparency/</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/353940259">https://zhuanlan.zhihu.com/p/353940259</a></li>
<li><a href="https://www.intel.com/content/www/us/en/developer/articles/technical/oit-approximation-with-pixel-synchronization.html">https://www.intel.com/content/www/us/en/developer/articles/technical/oit-approximation-with-pixel-synchronization.html</a></li>
<li><a href="https://learn.microsoft.com/en-us/windows/win32/direct3d11/rasterizer-order-views">https://learn.microsoft.com/en-us/windows/win32/direct3d11/rasterizer-order-views</a></li>
<li><a href="https://wlog.flatlib.jp/2015/07/22/n1775/">https://wlog.flatlib.jp/2015/07/22/n1775/</a></li>
</ul>
</section>
</main>
<script>
/******************************************************************************
 *                 JS Extension for the W3C Spec Style Sheet                  *
 *                                                                            *
 * This code handles:                                                         *
 * - some fixup to improve the table of contents                              *
 * - the obsolete warning on outdated specs                                   *
 ******************************************************************************/

/**
 * Steal by include-yy
 * 2024-05-01 17:32
 * delete the Deprecation warning and dark mode toggle part
 **/

(function() {
  "use strict";

  var ESCAPEKEY = 27;
  var collapseSidebarText = '<span aria-hidden="true">â</span> '
                          + '<span>Collapse Sidebar</span>';
  var expandSidebarText   = '<span aria-hidden="true">â</span> '
                          + '<span>Pop Out Sidebar</span>';
  var tocJumpText         = '<span aria-hidden="true">â</span> '
                          + '<span>Jump to Table of Contents</span>';

  var sidebarMedia = window.matchMedia('screen and (min-width: 78em)');
  var autoToggle   = function(e){ toggleSidebar(e.matches) };
  var toc = document.getElementById('toc');
  if(sidebarMedia.addListener && toc) {
    sidebarMedia.addListener(autoToggle);
  }

  function toggleSidebar(on, skipScroll) {
    if (on == undefined) {
      on = !document.body.classList.contains('toc-sidebar');
    }

    if (!skipScroll) {
      /* Don't scroll to compensate for the ToC if we're above it already. */
      var headY = 0;
      var head = document.querySelector('.head');
      if (head) {
        // terrible approx of "top of ToC"
        headY += head.offsetTop + head.offsetHeight;
      }
      skipScroll = window.scrollY < headY;
    }

    var toggle = document.getElementById('toc-toggle');
    var tocNav = document.getElementById('toc');
    if (on) {
      var tocHeight = tocNav.offsetHeight;
      document.body.classList.add('toc-sidebar');
      document.body.classList.remove('toc-inline');
      toggle.innerHTML = collapseSidebarText;
      if (!skipScroll) {
        window.scrollBy(0, 0 - tocHeight);
      }
      tocNav.focus();
      sidebarMedia.addListener(autoToggle); // auto-collapse when out of room
    }
    else {
      document.body.classList.add('toc-inline');
      document.body.classList.remove('toc-sidebar');
      toggle.innerHTML = expandSidebarText;
      if (!skipScroll) {
        window.scrollBy(0, tocNav.offsetHeight);
      }
      if (toggle.matches(':hover')) {
        /* Unfocus button when not using keyboard navigation,
           because I don't know where else to send the focus. */
        toggle.blur();
      }
    }
  }

  function createSidebarToggle() {
    /* Create the sidebar toggle in JS; it shouldn't exist when JS is off. */
    var toggle = document.createElement('a');
      /* This should probably be a button, but appearance isn't standards-track.*/
    toggle.id = 'toc-toggle';
    toggle.class = 'toc-toggle';
    toggle.href = '#toc';
    toggle.innerHTML = collapseSidebarText;

    sidebarMedia.addListener(autoToggle);
    var toggler = function(e) {
      e.preventDefault();
      sidebarMedia.removeListener(autoToggle); // persist explicit off states
      toggleSidebar();
      return false;
    }
    toggle.addEventListener('click', toggler, false);


    /* Get <nav id=toc-nav>, or make it if we don't have one. */
    var tocNav = document.getElementById('toc-nav');
    if (!tocNav) {
      tocNav = document.createElement('p');
      tocNav.id = 'toc-nav';
      /* Prepend for better keyboard navigation */
      document.body.insertBefore(tocNav, document.body.firstChild);
    }
    /* While we're at it, make sure we have a Jump to Toc link. */
    var tocJump = document.getElementById('toc-jump');
    if (!tocJump) {
      tocJump = document.createElement('a');
      tocJump.id = 'toc-jump';
      tocJump.href = '#toc';
      tocJump.innerHTML = tocJumpText;
      tocNav.appendChild(tocJump);
    }

    tocNav.appendChild(toggle);
  }

  var toc = document.getElementById('toc');
  if (toc) {
    if (!document.getElementById('toc-toggle')) {
      createSidebarToggle();
    }
    toggleSidebar(sidebarMedia.matches, true);

    /* If the sidebar has been manually opened and is currently overlaying the text
       (window too small for the MQ to add the margin to body),
       then auto-close the sidebar once you click on something in there. */
    toc.addEventListener('click', function(e) {
      if(document.body.classList.contains('toc-sidebar') && !sidebarMedia.matches) {
        var el = e.target;
        while (el != toc) { // find closest <a>
          if (el.tagName.toLowerCase() == "a") {
            toggleSidebar(false);
            return;
          }
          el = el.parentElement;
        }
      }
    }, false);
  }
  else {
    console.warn("Can't find Table of Contents. Please use <nav id='toc'> around the ToC.");
  }

  /* Amendment Diff Toggling */
  var showDiff = function(event) {
    var a = event.target.parentElement.parentElement;
    var ins = document.querySelectorAll("ins[cite='#" + a.id + "'], #" + a.id + " ins" );
    var del = document.querySelectorAll("del[cite='#" + a.id + "'], #" + a.id + " del" );
    ins.forEach( function(e) { e.hidden = false; e.classList.remove("diff-inactive") });
    del.forEach( function(e) { e.hidden = false; e.classList.remove("diff-inactive") });
    a.querySelectorAll("button[value=diff]")[0].disabled = true;
    a.querySelectorAll("button[value=old]")[0].disabled = false;
    a.querySelectorAll("button[value=new]")[0].disabled = false;
  }
  var showOld = function(event) {
    var a = event.target.parentElement.parentElement;
    var ins = document.querySelectorAll("ins[cite='#" + a.id + "'], #" + a.id + " ins" );
    var del = document.querySelectorAll("del[cite='#" + a.id + "'], #" + a.id + " del" );
    ins.forEach( function(e) { e.hidden = true;  e.classList.add("diff-inactive") });
    del.forEach( function(e) { e.hidden = false; e.classList.add("diff-inactive") });
    a.querySelectorAll("button[value=diff]")[0].disabled = false;
    a.querySelectorAll("button[value=old]")[0].disabled = true;
    a.querySelectorAll("button[value=new]")[0].disabled = false;
  }
  var showNew = function(event) {
    var a = event.target.parentElement.parentElement;
    var ins = document.querySelectorAll("ins[cite='#" + a.id + "'], #" + a.id + " ins" );
    var del = document.querySelectorAll("del[cite='#" + a.id + "'], #" + a.id + " del" );
    ins.forEach( function(e) { e.hidden = false;  e.classList.add("diff-inactive") });
    del.forEach( function(e) { e.hidden = true; e.classList.add("diff-inactive") });
    a.querySelectorAll("button[value=diff]")[0].disabled = false;
    a.querySelectorAll("button[value=old]")[0].disabled = false;
    a.querySelectorAll("button[value=new]")[0].disabled = true;
  }
  var amendments = document.querySelectorAll('[id].amendment, [id].correction, [id].addition');
  amendments.forEach( function(a) {
    var ins = document.querySelectorAll("ins[cite='#" + a.id + "'], #" + a.id + " ins" );
    var del = document.querySelectorAll("del[cite='#" + a.id + "'], #" + a.id + " del" );
    if (ins.length == 0 && del.length == 0) { return; }

    var tbar = document.createElement('div');
    tbar.lang = 'en'; tbar.class = 'amendment-toggles';

    var toggle = document.createElement('button');
    toggle.value = 'diff'; toggle.innerHTML = 'Show Change'; toggle.disabled = true;
    toggle.addEventListener('click', showDiff, false);
    tbar.appendChild(toggle);

    toggle = document.createElement('button');
    toggle.value = 'old'; toggle.innerHTML = 'Show Current';
    toggle.addEventListener('click', showOld, false);
    tbar.appendChild(toggle);

    toggle = document.createElement('button');
    toggle.value = 'new'; toggle.innerHTML = 'Show Future';
    toggle.addEventListener('click', showNew, false);
    tbar.appendChild(toggle);

    a.appendChild(tbar);
  });

  /* Wrap tables in case they overflow */
  var tables = document.querySelectorAll(':not(.overlarge) > table.data, :not(.overlarge) > table.index');
  var numTables = tables.length;
  for (var i = 0; i < numTables; i++) {
    var table = tables[i];
    if (!table.matches('.example *, .note *, .advisement *, .def *, .issue *')) {
      /* Overflowing colored boxes looks terrible, and also
         the kinds of tables inside these boxes
         are less likely to need extra space. */
      var wrapper = document.createElement('div');
      wrapper.className = 'overlarge';
      table.parentNode.insertBefore(wrapper, table);
      wrapper.appendChild(table);
    }
  }
})();

</script>
</body>

</html>
